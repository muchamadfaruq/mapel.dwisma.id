<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <title>Aplikasi Pemilihan Mapel DWISMA</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        :root {
            --primary: #0056b3;
            --primary-dark: #003d80;
            --secondary: #ffcc00;
            --surface: #ffffff;
            --bg-body: #f0f4f8;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            background-image:
                radial-gradient(at 0% 0%, rgba(0, 86, 179, 0.05) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(0, 86, 179, 0.05) 0px, transparent 50%);
            color: #334155;
        }

        .pro-card {
            background: var(--surface);
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            border-radius: 1.5rem;
        }

        .header-gradient {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            position: relative;
            overflow: hidden;
        }

        .header-pattern {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .btn-official {
            background-color: var(--primary);
            color: white;
            transition: all 0.2s ease;
            border-bottom: 3px solid var(--primary-dark);
        }

        .btn-official:hover:not(:disabled) {
            background-color: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(0, 86, 179, 0.3);
        }

        .btn-official:active:not(:disabled) {
            transform: translateY(1px);
            border-bottom-width: 0px;
            margin-top: 3px;
        }

        .btn-official:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            border-bottom-width: 0px;
        }

        .tab-active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .tab-inactive {
            background-color: white;
            color: #64748b;
            border-color: #e2e8f0;
        }

        /* Hide scrollbar */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .fade-in {
            animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23475569'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.25rem;
        }

        /* Custom Checkbox Style */
        .custom-checkbox {
            width: 1.2rem;
            height: 1.2rem;
            border-radius: 0.3rem;
            border: 2px solid #cbd5e1;
            cursor: pointer;
            accent-color: #ef4444;
            /* Red for delete actions */
        }

        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #10B981;
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: #10B981;
        }

        /* --- TAMBAHAN STYLE MODAL --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            margin: 15% auto;
            background-color: #fff;
            padding: 25px;
            border-radius: 1rem;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            position: relative;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>

<body class="min-h-screen antialiased flex flex-col items-center">

    <div class="w-full h-2 bg-gradient-to-r from-blue-600 via-blue-500 to-yellow-400"></div>

    <div class="container mx-auto px-4 py-8 max-w-5xl w-full">
        <div class="pro-card overflow-hidden fade-in shadow-xl">

            <!-- HEADER -->
            <div class="header-gradient px-6 py-10 md:p-12 text-white relative">
                <div class="header-pattern"></div>

                <div class="relative z-10 flex flex-col md:flex-row items-start md:items-center justify-between gap-8">
                    <div class="flex items-center gap-6">
                        <!-- LOGO -->
                        <div
                            class="w-20 h-20 md:w-24 md:h-24 bg-white rounded-full p-2 shadow-lg flex items-center justify-center shrink-0 border-4 border-blue-200/30 overflow-hidden">
                            <img src="/img/Logo Dwisma.png" alt="Logo Dwisma" class="w-full h-full object-contain">
                        </div>

                        <div class="space-y-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span
                                    class="bg-yellow-400 text-blue-900 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider shadow-sm">APLIKASI</span>
                            </div>
                            <h1 class="text-2xl md:text-4xl font-extrabold tracking-tight leading-tight">
                                Pemilihan Mapel <br />
                                <span class="text-yellow-300">DWISMA</span>
                            </h1>
                            <p id="subTitleHeader"
                                class="text-blue-100 text-sm font-medium tracking-wide opacity-90 border-l-2 border-yellow-400 pl-3 mt-2">
                                SMA Negeri 2 Mengwi • Tahun Ajaran 2025/2026
                            </p>
                        </div>
                    </div>

                    <div id="userBadge" class="hidden animate-fade-in self-end md:self-center">
                        <div
                            class="flex items-center gap-4 bg-white/10 backdrop-blur-md p-2 pr-5 rounded-xl border border-white/20 shadow-lg">
                            <div
                                class="w-10 h-10 bg-white rounded-lg flex items-center justify-center text-blue-700 shadow-sm">
                                <i class="fa-solid fa-user-check"></i>
                            </div>
                            <div class="text-right md:text-left">
                                <p id="userName" class="font-bold text-sm tracking-wide text-white">-</p>
                                <p id="userRole" class="text-[10px] font-bold uppercase tracking-wider text-yellow-300">
                                    -</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MAIN CONTENT -->
            <div id="mainContent" class="p-6 md:p-12 min-h-[500px] bg-white relative">
                <div
                    class="absolute top-0 right-0 -mt-20 -mr-20 w-80 h-80 bg-blue-50 rounded-full blur-3xl opacity-50 pointer-events-none">
                </div>
                <div
                    class="absolute bottom-0 left-0 -mb-20 -ml-20 w-80 h-80 bg-yellow-50 rounded-full blur-3xl opacity-50 pointer-events-none">
                </div>

                <!-- Initial Loading -->
                <div class="relative z-10 flex flex-col items-center justify-center py-32 space-y-6">
                    <div class="relative">
                        <div class="w-16 h-16 border-4 border-blue-100 border-t-blue-600 rounded-full animate-spin">
                        </div>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div class="w-2 h-2 bg-blue-600 rounded-full"></div>
                        </div>
                    </div>
                    <p class="text-slate-400 font-semibold text-sm tracking-widest uppercase animate-pulse">
                        Menghubungkan ke Server...</p>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div
            class="mt-8 text-center md:text-left flex flex-col md:flex-row items-center justify-between gap-4 px-4 opacity-70">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-shield-halved text-blue-600 text-xs"></i>
                <p class="text-slate-500 text-[11px] font-semibold uppercase tracking-widest">© 2026 •
                    TIM TEKNOLOGI INFORMASI</p>
            </div>
            <p class="text-[10px] text-slate-400">SMA NEGERI 2 MENGWI</p>
        </div>
    </div>

    <!-- --- TAMBAHAN: MODAL LOGIN MANUAL (Popup Password) --- -->
    <div id="manualLoginModal" class="modal">
        <div class="modal-content">
            <div class="text-center mb-6">
                <div
                    class="w-12 h-12 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-3 text-xl">
                    <i class="fa-solid fa-lock"></i>
                </div>
                <h2 class="text-xl font-bold text-slate-800">Login Admin Manual</h2>
                <p class="text-slate-500 text-xs mt-1">Masukkan Kode Akses Rahasia</p>
            </div>
            <input type="password" id="manualPassInput" placeholder="Kode Akses (cth: admin123)"
                class="w-full p-3 border border-slate-300 rounded-lg outline-none focus:border-blue-500 mb-4 text-center font-bold tracking-widest text-lg">
            <button onclick="submitManualLogin()"
                class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition mb-2 shadow-lg">Masuk
                Dashboard</button>
            <button onclick="closeModal()"
                class="w-full py-2 text-slate-400 text-xs hover:text-slate-600 font-bold">Batal</button>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // ============================================
        // KONFIGURASI API (WAJIB DIISI)
        // ============================================
        const API_URL = "https://script.google.com/macros/s/AKfycbzudDNj3qz59nc4igQ-LQsN9c2um62YGf26s0EiqINk0aJUMEzgv5bDa5ZgHBnFnDhcGA/exec";

        let sessionSiswa = null;
        let allUsersData = [];
        let rawActivities = [];
        let currentMonitorView = 'log';
        let isSystemOpen = true; // Default

        // === CLIENT SIDE API HANDLER ===
        async function callAPI(action, payload = null) {
            if (!API_URL || API_URL.includes("TEMPELKAN_URL")) {
                alert("Error Konfigurasi: URL API Web App belum disetting di file index.html!");
                return null;
            }

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: action, payload: payload })
                });

                const result = await response.json();
                return result;
            } catch (error) {
                console.error("API Error:", error);
                alert("Gagal terhubung ke server. Periksa koneksi internet.");
                return null;
            }
        }

        function startApp() {
            callAPI('getAllUsers').then(data => {
                allUsersData = data || [];
                checkLoginStatus();
            });
        }

        function checkLoginStatus(manualCheck = false) {
            const btn = document.getElementById('btnAdminLogin');
            if (manualCheck && btn) {
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Memeriksa Akses...';
                btn.disabled = true;
            }

            callAPI('getUserData').then(user => {
                if (user && user.isLogged && (user.role === 'Admin' || user.role === 'BK' || user.role === 'Staff')) {
                    updateHeaderInfo(user.nama || "Admin", user.role);
                    renderDashboardLayout();
                } else {
                    if (manualCheck) {
                        document.getElementById('manualLoginModal').style.display = "block";
                        document.getElementById('manualPassInput').value = "";
                        document.getElementById('manualPassInput').focus();
                        if (btn) {
                            btn.innerHTML = '<i class="fa-solid fa-user-shield"></i><span>Akses Dashboard Guru/Admin</span>';
                            btn.disabled = false;
                        }
                    } else {
                        renderGuestForm();
                    }
                }
            });
        }

        function submitManualLogin() {
            const code = document.getElementById('manualPassInput').value;
            if (!code) return alert("Masukkan kode akses!");

            const btn = document.querySelector('#manualLoginModal button');
            const originalText = btn.innerText;
            btn.innerText = "Memproses..."; btn.disabled = true;

            callAPI('loginWithPassword', code).then(res => {
                if (res && res.success) {
                    closeModal();
                    updateHeaderInfo(res.user.nama, res.user.role);
                    renderDashboardLayout();
                } else {
                    alert("⛔ KODE AKSES SALAH!");
                    btn.innerText = originalText; btn.disabled = false;
                    document.getElementById('manualPassInput').value = "";
                    document.getElementById('manualPassInput').focus();
                }
            });
        }

        function closeModal() {
            document.getElementById('manualLoginModal').style.display = "none";
        }

        window.onload = startApp;

        function updateHeaderInfo(nama, info) {
            const badge = document.getElementById('userBadge');
            if (badge) {
                document.getElementById('userName').innerText = nama;
                document.getElementById('userRole').innerText = info;
                badge.classList.remove('hidden');
            }
        }

        // --- LOGIN VIEW ---
        function renderGuestForm() {
            document.getElementById('userBadge').classList.add('hidden');
            document.getElementById('mainContent').innerHTML = `
          <div class="max-w-md mx-auto fade-in py-6">
            <div class="text-center space-y-3 mb-10">
              <div class="inline-flex p-4 bg-blue-50 rounded-2xl text-blue-700 shadow-sm border border-blue-100 mb-2">
                <i class="fa-solid fa-id-card text-3xl"></i>
              </div>
              <h2 class="text-2xl font-bold text-slate-800 tracking-tight">Portal Siswa</h2>
              <p class="text-slate-500 text-sm px-4 leading-relaxed">Silakan masukkan NISN Anda untuk memulai proses pemilihan kelompok mata pelajaran.</p>
            </div>
            
            <div class="space-y-6 bg-white p-1 rounded-3xl">
              <div class="relative group">
                <div class="absolute inset-y-0 left-0 pl-5 flex items-center pointer-events-none">
                  <i class="fa-solid fa-hashtag text-slate-300 group-focus-within:text-blue-500 transition-colors"></i>
                </div>
                <input type="number" id="regNISN" placeholder="Masukkan NISN..." 
                  class="w-full pl-12 pr-6 py-5 bg-slate-50 border-2 border-slate-100 rounded-2xl text-lg font-bold outline-none focus:border-blue-500 focus:bg-white transition-all shadow-sm text-slate-700 placeholder-slate-400">
              </div>
              <button onclick="checkNISN()" id="btnVerify" class="btn-official w-full py-5 rounded-2xl font-bold text-lg flex items-center justify-center gap-3">
                <span>Masuk & Memilih</span>
                <i class="fa-solid fa-arrow-right"></i>
              </button>
            </div>
            
            <div class="mt-8 text-center space-y-6">
              <p class="text-xs text-slate-400 bg-slate-50 inline-block px-3 py-1 rounded-full border border-slate-100">
                <i class="fa-solid fa-circle-info mr-1"></i> Pastikan NISN sudah terdaftar di Dapodik
              </p>

              <!-- TOMBOL BARU: AKSES DASHBOARD ADMIN -->
              <div class="border-t border-slate-100 pt-6">
                  <button id="btnAdminLogin" onclick="checkLoginStatus(true)" class="text-xs font-bold text-slate-400 hover:text-blue-600 transition-colors flex items-center justify-center gap-2 mx-auto px-4 py-2 hover:bg-blue-50 rounded-lg">
                    <i class="fa-solid fa-user-shield"></i>
                    <span>Akses Dashboard Guru/Admin</span>
                  </button>
              </div>
            </div>
          </div>
        `;
        }

        function checkNISN() {
            const nisn = document.getElementById('regNISN').value;
            if (!nisn) return alert("Silakan isi NISN!");
            const btn = document.getElementById('btnVerify');
            btn.disabled = true;
            btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Verifikasi Data...`;

            callAPI('verifyNISN', nisn).then(res => {
                if (res && res.success) {
                    sessionSiswa = res;
                    updateHeaderInfo(res.nama, res.kelas);

                    // --- NEW: SYSTEM CLOSED CHECK ---
                    // If system is CLOSED (res.isSystemOpen === false) AND user hasn't chosen yet
                    if (res.isSystemOpen === false && !res.sudahMemilih) {
                        renderClosedPage();
                        return;
                    }

                    res.sudahMemilih ? renderHasilPilihan(res) : renderSiswaForm();
                } else {
                    alert(res ? res.message : "Gagal menghubungi server.");
                    renderGuestForm();
                }
            });
        }

        function renderClosedPage() {
            document.getElementById('mainContent').innerHTML = `
            <div class="text-center py-20 fade-in max-w-lg mx-auto">
                <div class="w-24 h-24 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6 shadow-sm">
                   <i class="fa-solid fa-calendar-xmark text-4xl text-red-600"></i>
                </div>
                <h2 class="text-2xl font-bold text-slate-800 mb-2">Pendaftaran Ditutup</h2>
                <p class="text-slate-500 mb-8 leading-relaxed">Mohon maaf, sesi pemilihan mata pelajaran ditutup. Hubungi Guru BK jika ada kendala.</p>
                
                <button onclick="renderGuestForm()" class="text-slate-400 hover:text-blue-600 font-bold text-sm">Kembali ke Halaman Utama</button>
            </div>
          `;
        }

        function reloadSession() {
            if (!sessionSiswa || !sessionSiswa.nisn) return;
            callAPI('verifyNISN', sessionSiswa.nisn).then(res => {
                if (res && res.success) {
                    sessionSiswa = res;
                    renderHasilPilihan(res);
                }
            });
        }

        function renderSiswaForm() {
            const container = document.getElementById('mainContent');
            container.innerHTML = `
          <div class="flex flex-col items-center justify-center py-20 space-y-4">
            <i class="fa-solid fa-cloud-arrow-down text-4xl text-blue-200 animate-bounce"></i>
            <p class="text-slate-400 font-semibold text-xs tracking-widest uppercase">Mengambil Data Kuota...</p>
          </div>`;

            callAPI('getMapelOptions').then(mapels => {
                if (!mapels || mapels.length === 0) {
                    container.innerHTML = `
              <div class="text-center py-10 fade-in">
                <div class="text-red-500 mb-4 inline-block p-4 bg-red-50 rounded-2xl"><i class="fa-solid fa-database text-3xl"></i></div>
                <p class="text-slate-800 font-bold text-xl mb-2">Data Mapel Tidak Ditemukan</p>
                <p class="text-sm text-slate-500 mb-6">Hubungi Admin Kurikulum Sekolah.</p>
                <button onclick="renderGuestForm()" class="text-slate-500 hover:text-blue-600 font-bold text-sm">Kembali</button>
              </div>`;
                    return;
                }

                let optionsHtml = mapels.map(m => {
                    const isFull = m.sisa <= 0;
                    const label = isFull ? '(PENUH) ⛔' : `(Sisa: ${m.sisa}) ✅`;
                    return `<option value="${m.nama}" ${isFull ? 'disabled class="bg-slate-100 text-slate-400"' : 'class="font-semibold text-slate-800"'}>
                      ${m.nama} ${label}
                    </option>`;
                }).join('');

                container.innerHTML = `
            <div class="max-w-4xl mx-auto fade-in space-y-8">
              <div class="p-6 bg-gradient-to-r from-slate-50 to-white rounded-2xl border border-slate-200 flex flex-col md:flex-row md:items-center justify-between gap-4 shadow-sm">
                <div class="flex items-center gap-4">
                  <div class="w-14 h-14 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 text-xl border-4 border-white shadow-sm">
                    <i class="fa-solid fa-user-graduate"></i>
                  </div>
                  <div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Identitas Siswa</p>
                    <h3 class="text-xl font-bold text-slate-800">${sessionSiswa.nama}</h3>
                  </div>
                </div>
                <div class="flex items-center gap-3 bg-white px-4 py-2 rounded-xl border border-slate-100 shadow-sm">
                   <i class="fa-solid fa-layer-group text-blue-500"></i>
                   <span class="text-sm font-bold text-slate-600">${sessionSiswa.kelas}</span>
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-12 gap-8">
                <div class="md:col-span-12 space-y-6">
                  <div class="space-y-2">
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest ml-1">Pilih Paket Mapel</label>
                    <div class="relative">
                      <select id="pilihanMapel" onchange="updateInfoMapel(this)" class="w-full p-5 pr-12 border border-slate-300 bg-white rounded-xl outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 font-bold transition-all text-slate-700 text-lg shadow-sm cursor-pointer hover:border-blue-400">
                        <option value="" disabled selected>-- Klik untuk memilih paket --</option>
                        ${optionsHtml}
                      </select>
                    </div>
                  </div>

                  <div id="mapelDetailBox" class="p-6 bg-blue-50 rounded-2xl border border-blue-100 hidden transition-all duration-300 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-blue-100 rounded-full blur-2xl -mr-10 -mt-10"></div>
                    <div class="relative z-10 flex flex-col gap-3">
                       <div class="flex items-center gap-2 text-blue-800">
                          <i class="fa-solid fa-book-open"></i>
                          <p class="text-xs font-bold uppercase tracking-widest">Rincian Mata Pelajaran</p>
                       </div>
                       <p id="mapelDetailText" class="text-sm text-slate-700 font-medium leading-relaxed whitespace-pre-line pl-6 border-l-2 border-blue-200"></p>
                    </div>
                  </div>

                  <div class="flex gap-4 p-4 bg-yellow-50 rounded-xl border border-yellow-100 text-yellow-800 text-xs items-start">
                    <i class="fa-solid fa-triangle-exclamation mt-1"></i>
                    <p class="leading-relaxed font-medium">
                      Perhatian: Pilihan bersifat <b>FINAL</b>. Setelah tombol simpan ditekan, kuota akan otomatis berkurang dan Anda tidak dapat mengubahnya lagi secara mandiri.
                    </p>
                  </div>
                </div>
              </div>

              <div class="pt-2 space-y-4">
                <button onclick="savePilihan()" id="btnSave" class="btn-official w-full py-4 rounded-xl font-bold text-lg uppercase tracking-wide flex items-center justify-center gap-3">
                  <i class="fa-solid fa-floppy-disk"></i>
                  <span>Simpan Permanen</span>
                </button>
                <button onclick="renderGuestForm()" class="w-full text-slate-400 text-xs font-bold py-3 hover:text-slate-600 transition-colors uppercase tracking-widest">Batal / Logout</button>
              </div>
            </div>`;
                window.mapelCache = mapels;
            });
        }

        function updateInfoMapel(el) {
            const detailBox = document.getElementById('mapelDetailBox');
            const detailText = document.getElementById('mapelDetailText');
            const val = el.value;

            if (window.mapelCache && val) {
                const selected = window.mapelCache.find(m => m.nama === val);
                if (selected && selected.deskripsi) {
                    detailBox.classList.remove('hidden');
                    detailText.innerText = selected.deskripsi;
                    detailBox.style.opacity = "0";
                    detailBox.style.transform = "translateY(5px)";
                    setTimeout(() => {
                        detailBox.style.opacity = "1";
                        detailBox.style.transform = "translateY(0)";
                    }, 50);
                } else {
                    detailBox.classList.add('hidden');
                }
            } else {
                detailBox.classList.add('hidden');
            }
        }

        function savePilihan() {
            if (!sessionSiswa) return alert("Sesi kadaluarsa, silakan muat ulang halaman.");
            const pilihanEl = document.getElementById('pilihanMapel');
            if (!pilihanEl) return;
            const pilihan = pilihanEl.value;

            if (!pilihan) return alert("Harap pilih salah satu paket mata pelajaran terlebih dahulu!");
            if (!confirm(`KONFIRMASI AKHIR:\n\nApakah Anda yakin memilih paket: ${pilihan}?\n\nData akan dikunci setelah ini.`)) return;

            const btn = document.getElementById('btnSave');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Menyimpan Data...`;

            callAPI('submitPilihan', {
                nisn: sessionSiswa.nisn,
                pilihan: pilihan
            }).then(res => {
                if (res && (res.includes("Sukses") || res.includes("berhasil"))) {
                    sessionSiswa.sudahMemilih = true;
                    sessionSiswa.pilihanAnda = pilihan;
                    reloadSession();
                } else {
                    alert(res || "Gagal menyimpan.");
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            });
        }

        function renderHasilPilihan(data) {
            const deskripsiHtml = data.deskripsiPilihan && data.deskripsiPilihan !== "Detail belum diisi"
                ? `<div class="bg-blue-50 p-6 rounded-2xl border border-blue-100 text-left mt-6">
                <div class="flex items-center gap-2 mb-3">
                  <i class="fa-solid fa-list-ul text-blue-600"></i>
                  <p class="text-xs font-bold text-blue-600 uppercase tracking-widest">Detail Mata Pelajaran</p>
                </div>
                <p class="text-sm text-slate-700 font-medium whitespace-pre-line leading-relaxed">${data.deskripsiPilihan}</p>
              </div>`
                : `<div class="bg-slate-50 p-4 rounded-xl border border-slate-100 text-left mt-6 text-slate-400 text-xs italic text-center">Detail mapel belum tersedia</div>`;

            document.getElementById('mainContent').innerHTML = `
          <div class="text-center py-10 fade-in max-w-lg mx-auto space-y-8">
            <div class="relative">
               <div class="p-8 md:p-10 bg-white rounded-3xl border border-slate-100 shadow-xl relative z-10 overflow-hidden">
                 <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-sm">
                   <i class="fa-solid fa-check text-2xl"></i>
                 </div>
                 <div class="space-y-2 mb-8">
                   <h3 class="text-2xl font-bold text-slate-800">${data.nama}</h3>
                   <span class="inline-block bg-blue-50 text-blue-600 font-bold text-xs px-3 py-1 rounded-md uppercase tracking-wide border border-blue-100">${data.kelas}</span>
                 </div>
                 
                 <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200 border-dashed relative group">
                   <p class="text-[10px] text-slate-400 uppercase font-bold tracking-widest mb-2">Pilihan Anda</p>
                   <p class="text-2xl font-extrabold text-blue-700 tracking-tight">${data.pilihanAnda}</p>
                   <div class="absolute top-2 right-2 text-slate-300">
                      <i class="fa-solid fa-lock"></i>
                   </div>
                 </div>
                 
                 ${deskripsiHtml}
                 
                 <div class="mt-8 pt-6 border-t border-slate-100">
                    <p class="text-slate-400 text-xs">Tercatat pada sistem kami.</p>
                 </div>
               </div>
            </div>
            
            <button onclick="renderGuestForm()" class="btn-official w-full py-4 rounded-xl font-bold text-sm uppercase tracking-widest shadow-lg flex items-center justify-center gap-2">
               <i class="fa-solid fa-right-from-bracket"></i>
               <span>Keluar Aplikasi</span>
            </button>
          </div>`;
        }

        // --- DASHBOARD SYSTEM ---
        function renderDashboardLayout() {
            const container = document.getElementById('mainContent');
            container.innerHTML = `
            <div class="fade-in space-y-6">
                <!-- TABS NAVIGATION (Responsive Scrollable) -->
                <div class="flex space-x-2 bg-slate-100 p-1 rounded-xl overflow-x-auto no-scrollbar">
                    <button onclick="switchTab('monitoring')" id="tab-monitoring" class="flex-1 py-3 text-sm font-bold rounded-lg transition-all border shadow-sm tab-active whitespace-nowrap px-4 min-w-fit">
                       <i class="fa-solid fa-chart-line mr-2"></i> Monitoring
                    </button>
                    <button onclick="switchTab('mapel')" id="tab-mapel" class="flex-1 py-3 text-sm font-bold rounded-lg transition-all border border-transparent text-slate-500 hover:bg-slate-200 hover:text-slate-700 whitespace-nowrap px-4 min-w-fit">
                       <i class="fa-solid fa-folder-plus mr-2"></i> Pengaturan Mapel
                    </button>
                    <button onclick="switchTab('siswa')" id="tab-siswa" class="flex-1 py-3 text-sm font-bold rounded-lg transition-all border border-transparent text-slate-500 hover:bg-slate-200 hover:text-slate-700 whitespace-nowrap px-4 min-w-fit">
                       <i class="fa-solid fa-users-gear mr-2"></i> Data Siswa
                    </button>
                    <button onclick="switchTab('admin')" id="tab-admin" class="flex-1 py-3 text-sm font-bold rounded-lg transition-all border border-transparent text-slate-500 hover:bg-slate-200 hover:text-slate-700 whitespace-nowrap px-4 min-w-fit">
                       <i class="fa-solid fa-user-shield mr-2"></i> Manajemen Admin
                    </button>
                </div>

                <!-- CONTENT AREA -->
                <div id="dashboardContent" class="min-h-[400px]">
                    <!-- LOADED DYNAMICALLY -->
                </div>
            </div>
         `;
            loadMonitoringData();
        }

        function switchTab(tabName) {
            const tabMon = document.getElementById('tab-monitoring');
            const tabMap = document.getElementById('tab-mapel');
            const tabSiswa = document.getElementById('tab-siswa');
            const tabAdmin = document.getElementById('tab-admin');

            const activeClass = "flex-1 py-3 text-sm font-bold rounded-lg transition-all border shadow-sm tab-active whitespace-nowrap px-4 min-w-fit";
            const inactiveClass = "flex-1 py-3 text-sm font-bold rounded-lg transition-all border border-transparent text-slate-500 hover:bg-slate-200 hover:text-slate-700 whitespace-nowrap px-4 min-w-fit";

            tabMon.className = inactiveClass;
            tabMap.className = inactiveClass;
            tabSiswa.className = inactiveClass;
            tabAdmin.className = inactiveClass;

            if (tabName === 'monitoring') {
                tabMon.className = activeClass;
                loadMonitoringData();
            } else if (tabName === 'mapel') {
                tabMap.className = activeClass;
                loadMapelManager();
            } else if (tabName === 'siswa') {
                tabSiswa.className = activeClass;
                loadSiswaManager();
            } else if (tabName === 'admin') {
                tabAdmin.className = activeClass;
                loadStaffManager();
            }
        }

        // --- BULK DELETE HELPERS ---
        function toggleAll(source, targetClass) {
            const checkboxes = document.querySelectorAll(`.${targetClass}`);
            checkboxes.forEach(cb => cb.checked = source.checked);
            updateBulkBtn(targetClass, source.getAttribute('data-btn'));
        }

        function updateBulkBtn(targetClass, btnId) {
            const checked = document.querySelectorAll(`.${targetClass}:checked`).length;
            const btn = document.getElementById(btnId);
            const countSpan = document.getElementById(btnId + '-count');
            if (btn) {
                if (checked > 0) {
                    btn.classList.remove('hidden');
                    if (countSpan) countSpan.innerText = checked;
                } else {
                    btn.classList.add('hidden');
                }
            }
        }

        async function processBulkDelete(targetClass, btnId, deleteFunction, idField) {
            const checkedBoxes = Array.from(document.querySelectorAll(`.${targetClass}:checked`));
            const total = checkedBoxes.length;
            if (total === 0) return;

            if (!confirm(`⚠️ HAPUS MASSAL:\n\nAnda akan menghapus ${total} data terpilih.\nTindakan ini tidak dapat dibatalkan.\n\nLanjutkan?`)) return;

            const btn = document.getElementById(btnId);
            const originalText = btn.innerHTML;
            btn.disabled = true;

            for (let i = 0; i < total; i++) {
                const val = checkedBoxes[i].value;
                btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Hapus ${i + 1}/${total}...`;
                try {
                    await callAPI(deleteFunction, val);
                } catch (e) {
                    console.error("Gagal hapus " + val);
                }
            }

            btn.innerHTML = `<i class="fa-solid fa-check"></i> Selesai!`;
            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = originalText;
                // Refresh current tab
                const activeTab = document.querySelector('.tab-active');
                if (activeTab) activeTab.click();
            }, 1000);
        }


        // --- TAB 1: MONITORING ---
        function loadMonitoringData() {
            const content = document.getElementById('dashboardContent');
            content.innerHTML = `
          <div class="flex flex-col items-center justify-center py-20 space-y-4">
            <div class="w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin"></div>
            <p class="text-slate-400 font-bold text-xs tracking-widest uppercase">Memuat Log...</p>
          </div>`;
            callAPI('getRecentActivities').then(pilihans => {
                rawActivities = pilihans || [];
                renderMonitorContent();
            });
        }

        function switchMonitorView(view) {
            currentMonitorView = view;
            renderMonitorContent();
        }

        function renderMonitorContent() {
            const btnClassActive = "px-4 py-2 bg-white text-blue-700 font-bold text-xs rounded-lg shadow-sm border border-slate-200 transition-all";
            const btnClassInactive = "px-4 py-2 text-slate-500 font-bold text-xs hover:bg-slate-100 rounded-lg transition-all";

            const totalSiswa = allUsersData.length;
            const totalMemilih = new Set(rawActivities.map(a => String(a.nisn))).size;
            const totalBelum = totalSiswa - totalMemilih;

            const topMenu = `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
               <div class="p-6 bg-white rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between">
                 <div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Sudah Memilih</p>
                    <p class="text-3xl font-extrabold text-blue-700">${totalMemilih} <span class="text-sm font-medium text-slate-400">Siswa</span></p>
                 </div>
                 <div class="w-12 h-12 bg-blue-50 rounded-xl flex items-center justify-center text-blue-600"><i class="fa-solid fa-check-circle text-xl"></i></div>
               </div>
               
               <div class="p-6 bg-white rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between">
                 <div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Belum Memilih</p>
                    <p class="text-3xl font-extrabold text-red-600">${totalBelum} <span class="text-sm font-medium text-slate-400">Siswa</span></p>
                 </div>
                 <div class="w-12 h-12 bg-red-50 rounded-xl flex items-center justify-center text-red-600"><i class="fa-solid fa-times-circle text-xl"></i></div>
               </div>
            </div>

            <div class="flex justify-center md:justify-start gap-2 bg-slate-100 p-1 rounded-xl w-fit mb-6">
                <button onclick="switchMonitorView('log')" class="${currentMonitorView === 'log' ? btnClassActive : btnClassInactive}">
                   <i class="fa-solid fa-list mr-2"></i> Riwayat Pemilihan
                </button>
                <button onclick="switchMonitorView('unselected')" class="${currentMonitorView === 'unselected' ? btnClassActive : btnClassInactive}">
                   <i class="fa-solid fa-user-xmark mr-2"></i> Siswa Belum Memilih
                </button>
            </div>
          `;

            let content = "";
            if (currentMonitorView === 'log') {
                content = renderActivityLog();
            } else {
                content = renderUnselectedList();
            }

            document.getElementById('dashboardContent').innerHTML = `<div class="fade-in">${topMenu} ${content}</div>`;
        }

        function renderActivityLog() {
            const listKelas = [...new Set(allUsersData.map(u => u.kelas))].filter(Boolean).sort();
            const listMapel = [...new Set(rawActivities.map(p => p.pilihan))].filter(Boolean).sort();

            let filtered = rawActivities;
            const currentKelas = document.getElementById('filterKelas') ? document.getElementById('filterKelas').value : "";
            const currentMapel = document.getElementById('filterMapel') ? document.getElementById('filterMapel').value : "";

            if (currentKelas) {
                filtered = filtered.filter(p => {
                    const u = allUsersData.find(u => String(u.nisn) === String(p.nisn));
                    return u && u.kelas === currentKelas;
                });
            }
            if (currentMapel) {
                filtered = filtered.filter(p => p.pilihan === currentMapel);
            }

            let tableRows = filtered.map((p, index) => {
                const user = allUsersData.find(u => String(u.nisn) === String(p.nisn));
                return `
            <tr class="group border-b border-slate-100 hover:bg-blue-50/50 transition-colors">
              <td class="py-4 px-4 text-center"><input type="checkbox" class="custom-checkbox check-log" value="${p.nisn}" onclick="updateBulkBtn('check-log', 'btn-del-log')"></td>
              <td class="py-4 px-4 text-center text-xs font-bold text-slate-400">${index + 1}</td>
              <td class="py-4 px-4">
                <div class="flex items-center gap-3">
                   <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-xs font-bold text-blue-600 uppercase border border-blue-200">${user ? user.nama.charAt(0) : '?'}</div>
                   <div>
                      <p class="font-bold text-slate-700 text-sm">${user ? user.nama : 'Tidak Dikenal'}</p>
                      <p class="text-[10px] text-slate-400 font-mono">NISN: ${p.nisn}</p>
                   </div>
                </div>
              </td>
              <td class="py-4 px-4 text-center"><span class="bg-slate-100 text-slate-600 border border-slate-200 text-[10px] font-bold px-2 py-1 rounded">${user ? user.kelas : '-'}</span></td>
              <td class="py-4 px-4 text-center"><span class="inline-block px-3 py-1 bg-blue-600 text-white rounded-full text-[10px] font-bold uppercase tracking-wide shadow-sm">${p.pilihan}</span></td>
              <td class="py-4 px-4 text-center text-[10px] text-slate-500 font-medium font-mono">${p.waktu}</td>
              <td class="py-4 px-4 text-center">
                <button onclick="confirmDelete('${p.nisn}', '${user ? user.nama : p.nisn}')" class="w-8 h-8 flex items-center justify-center text-slate-300 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all border border-transparent hover:border-red-100"><i class="fa-solid fa-trash-can"></i></button>
              </td>
            </tr>`;
            }).join('');

            return `
          <div class="space-y-6">
            <div class="flex flex-col md:flex-row justify-between items-end md:items-center gap-6">
              <div class="space-y-1"><h2 class="text-xl font-bold text-slate-800">Log Aktivitas</h2><p class="text-xs text-slate-500">Real-time update.</p></div>
              <div class="flex flex-wrap items-center gap-3 w-full md:w-auto">
                 <!-- Bulk Button -->
                 <button id="btn-del-log" onclick="processBulkDelete('check-log', 'btn-del-log', 'deletePilihan')" class="hidden px-4 py-2.5 bg-red-600 text-white rounded-lg font-bold text-xs shadow-md hover:bg-red-700 transition-all flex items-center gap-2">
                    <i class="fa-solid fa-trash"></i> Hapus Terpilih (<span id="btn-del-log-count">0</span>)
                 </button>

                <div class="relative">
                    <i class="fa-solid fa-filter absolute left-3 top-3.5 text-slate-400 text-xs"></i>
                    <select id="filterKelas" onchange="renderMonitorContent()" class="pl-8 pr-8 py-2.5 text-xs font-bold border border-slate-200 rounded-lg bg-white text-slate-600 outline-none focus:border-blue-500 transition-all cursor-pointer">
                    <option value="">Semua Kelas</option>${listKelas.map(k => `<option value="${k}" ${k === currentKelas ? 'selected' : ''}>${k}</option>`).join('')}
                    </select>
                </div>
                <div class="relative">
                    <i class="fa-solid fa-layer-group absolute left-3 top-3.5 text-slate-400 text-xs"></i>
                    <select id="filterMapel" onchange="renderMonitorContent()" class="pl-8 pr-8 py-2.5 text-xs font-bold border border-slate-200 rounded-lg bg-white text-slate-600 outline-none focus:border-blue-500 transition-all cursor-pointer">
                    <option value="">Semua Paket</option>${listMapel.map(m => `<option value="${m}" ${m === currentMapel ? 'selected' : ''}>${m}</option>`).join('')}
                    </select>
                </div>
                <button onclick="loadMonitoringData()" class="p-2.5 bg-white border border-slate-200 text-blue-600 rounded-lg hover:bg-blue-50 transition-all shadow-sm active:scale-95"><i class="fa-solid fa-arrows-rotate"></i></button>
              </div>
            </div>
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
              <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                  <thead>
                    <tr class="bg-slate-50 border-b border-slate-200">
                      <th class="py-4 px-4 text-center"><input type="checkbox" class="custom-checkbox" data-btn="btn-del-log" onclick="toggleAll(this, 'check-log')"></th>
                      <th class="py-4 px-4 text-center text-[10px] font-bold text-slate-500 uppercase tracking-wider">No</th>
                      <th class="py-4 px-4 text-[10px] font-bold text-slate-500 uppercase tracking-wider">Identitas Siswa</th>
                      <th class="py-4 px-4 text-center text-[10px] font-bold text-slate-500 uppercase tracking-wider">Kelas</th>
                      <th class="py-4 px-4 text-center text-[10px] font-bold text-slate-500 uppercase tracking-wider">Pilihan Paket</th>
                      <th class="py-4 px-4 text-center text-[10px] font-bold text-slate-500 uppercase tracking-wider">Waktu Input</th>
                      <th class="py-4 px-4 text-center text-[10px] font-bold text-slate-500 uppercase tracking-wider">Aksi</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-slate-100">${tableRows || '<tr><td colspan="7" class="py-12 text-center text-slate-400 font-medium italic bg-slate-50/50">Belum ada data terekam</td></tr>'}</tbody>
                </table>
              </div>
            </div>
          </div>`;
        }

        function renderUnselectedList() {
            const selectedNISNs = new Set(rawActivities.map(a => String(a.nisn)));
            const unselected = allUsersData.filter(u => u.nisn && !selectedNISNs.has(String(u.nisn)));

            let tableRows = unselected.map((u, index) => {
                return `
              <tr class="group border-b border-slate-100 hover:bg-red-50/50 transition-colors">
                  <td class="py-4 px-4 text-center text-xs font-bold text-slate-400">${index + 1}</td>
                  <td class="py-4 px-4 font-mono text-xs font-bold text-slate-500">${u.nisn}</td>
                  <td class="py-4 px-4 font-bold text-slate-700 text-sm">${u.nama}</td>
                  <td class="py-4 px-4 text-center"><span class="bg-slate-100 text-slate-600 border border-slate-200 text-[10px] font-bold px-2 py-1 rounded">${u.kelas}</span></td>
                  <td class="py-4 px-4 text-center"><span class="bg-red-100 text-red-600 border border-red-200 text-[10px] font-bold px-2 py-1 rounded-full">Belum Memilih</span></td>
              </tr>`;
            }).join('');

            return `
           <div class="space-y-6">
             <div class="flex flex-col md:flex-row justify-between items-end md:items-center gap-6">
               <div class="space-y-1">
                   <h2 class="text-xl font-bold text-slate-800">Daftar Belum Memilih</h2>
                   <p class="text-xs text-slate-500">Data siswa yang belum melakukan input pilihan mapel.</p>
               </div>
               <button onclick="loadMonitoringData()" class="p-2.5 bg-white border border-slate-200 text-blue-600 rounded-lg hover:bg-blue-50 transition-all shadow-sm active:scale-95"><i class="fa-solid fa-arrows-rotate"></i></button>
             </div>
             <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
               <div class="overflow-x-auto">
                 <table class="w-full text-left border-collapse">
                   <thead>
                     <tr class="bg-slate-50 border-b border-slate-200">
                       <th class="py-4 px-4 text-center text-[10px] font-bold text-slate-500 uppercase tracking-wider">No</th>
                       <th class="py-4 px-4 text-[10px] font-bold text-slate-500 uppercase tracking-wider">NISN</th>
                       <th class="py-4 px-4 text-[10px] font-bold text-slate-500 uppercase tracking-wider">Nama Lengkap</th>
                       <th class="py-4 px-4 text-center text-[10px] font-bold text-slate-500 uppercase tracking-wider">Kelas</th>
                       <th class="py-4 px-4 text-center text-[10px] font-bold text-slate-500 uppercase tracking-wider">Status</th>
                     </tr>
                   </thead>
                   <tbody class="divide-y divide-slate-100">${tableRows || '<tr><td colspan="5" class="py-12 text-center text-slate-400 font-medium italic bg-slate-50/50">Semua siswa sudah memilih! 🎉</td></tr>'}</tbody>
                 </table>
               </div>
             </div>
           </div>`;
        }

        function confirmDelete(nisn, nama) {
            if (confirm(`⚠️ ADMIN:\nHapus data siswa ${nama} (${nisn})?\nKuota akan dikembalikan.`)) {
                callAPI('deletePilihan', nisn).then(res => {
                    alert(res.message);
                    if (res.success) loadMonitoringData();
                });
            }
        }

        // --- TAB 2: MANAJEMEN MAPEL ---
        function loadMapelManager() {
            const content = document.getElementById('dashboardContent');
            content.innerHTML = `
          <div class="flex flex-col items-center justify-center py-20 space-y-4">
            <div class="w-12 h-12 border-4 border-secondary border-t-yellow-600 rounded-full animate-spin"></div>
            <p class="text-slate-400 font-bold text-xs tracking-widest uppercase">Memuat Konfigurasi...</p>
          </div>`;

            // --- NEW: FETCH SYSTEM STATUS & MAPEL ---
            Promise.all([callAPI('getMapelOptions'), callAPI('getSystemStatus')]).then(values => {
                const mapels = values[0] || [];
                const status = values[1]; // Expected { isOpen: boolean }
                isSystemOpen = status ? status.isOpen : true;
                renderMapelManager(mapels);
            });
        }

        function toggleSystemStatus() {
            const toggle = document.getElementById('systemToggle');
            const newState = toggle.checked;
            const label = document.getElementById('systemStatusLabel');

            // Optimistic UI Update
            if (newState) {
                label.innerText = "PENDAFTARAN DIBUKA";
                label.classList.remove("text-red-500");
                label.classList.add("text-green-500");
            } else {
                label.innerText = "PENDAFTARAN DITUTUP";
                label.classList.remove("text-green-500");
                label.classList.add("text-red-500");
            }

            callAPI('updateSystemStatus', newState).then(res => {
                if (!res || !res.success) {
                    alert("Gagal update status!");
                    toggle.checked = !newState; // Revert
                } else {
                    isSystemOpen = newState;
                }
            });
        }

        function renderMapelManager(mapels) {
            let mapelRows = mapels.map((m, index) => {
                return `
            <tr class="border-b border-slate-100 hover:bg-slate-50">
               <td class="py-4 px-4 text-center"><input type="checkbox" class="custom-checkbox check-mapel" value="${m.nama}" onclick="updateBulkBtn('check-mapel', 'btn-del-mapel')"></td>
               <td class="py-4 px-4 text-center text-xs font-bold text-slate-400">${index + 1}</td>
               <td class="py-4 px-4 font-bold text-slate-700">${m.nama}</td>
               <td class="py-4 px-4 text-center">
                  <span class="bg-blue-50 text-blue-600 border border-blue-100 text-xs font-bold px-3 py-1 rounded-full">${m.kuotaMaks} Siswa</span>
               </td>
               <td class="py-4 px-4">
                  <p class="text-xs text-slate-500 line-clamp-2" title="${m.deskripsi}">${m.deskripsi}</p>
               </td>
               <td class="py-4 px-4 text-center">
                  <button onclick="hapusMapel('${m.nama}')" class="w-8 h-8 flex items-center justify-center text-slate-300 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all border border-transparent hover:border-red-100">
                     <i class="fa-solid fa-trash-can"></i>
                  </button>
               </td>
            </tr>
            `;
            }).join('');

            const statusColor = isSystemOpen ? "text-green-500" : "text-red-500";
            const statusText = isSystemOpen ? "PENDAFTARAN DIBUKA" : "PENDAFTARAN DITUTUP";

            document.getElementById('dashboardContent').innerHTML = `
            <div class="fade-in grid grid-cols-1 md:grid-cols-3 gap-8">
               
               <div class="md:col-span-1 space-y-6">
                  <!-- STATUS CARD -->
                  <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm relative overflow-hidden">
                      <div class="absolute top-0 right-0 w-20 h-20 bg-slate-50 rounded-full -mr-6 -mt-6"></div>
                      <div class="relative z-10">
                          <h3 class="font-bold text-slate-800 mb-4">Status Aplikasi</h3>
                          <div class="flex items-center justify-between">
                              <p id="systemStatusLabel" class="text-xs font-extrabold tracking-widest ${statusColor}">${statusText}</p>
                              
                              <div class="relative inline-block w-12 h-6 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="toggle" id="systemToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300 border-slate-300" ${isSystemOpen ? 'checked' : ''} onclick="toggleSystemStatus()"/>
                                <label for="systemToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer transition-colors duration-300"></label>
                              </div>
                          </div>
                          <p class="text-[10px] text-slate-400 mt-3">Jika ditutup, siswa tidak dapat mengakses form pemilihan.</p>
                      </div>
                  </div>

                  <!-- TAMBAH PAKET -->
                  <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                     <div class="flex items-center gap-2 mb-6 pb-4 border-b border-slate-100">
                        <i class="fa-solid fa-plus-circle text-blue-600"></i>
                        <h3 class="font-bold text-slate-800">Tambah Paket Baru</h3>
                     </div>
                     
                     <div class="space-y-4">
                        <div>
                           <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Nama Kelompok</label>
                           <input type="text" id="addNama" placeholder="Contoh: KELOMPOK 1" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-bold outline-none focus:border-blue-500 transition-all">
                        </div>
                        <div>
                           <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Kuota Maksimal</label>
                           <input type="number" id="addKuota" placeholder="36" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-bold outline-none focus:border-blue-500 transition-all">
                        </div>
                        <div>
                           <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Daftar Mapel (Deskripsi)</label>
                           <textarea id="addDeskripsi" rows="4" placeholder="1. Matematika Lanjut&#10;2. Fisika&#10;3. Kimia" class="w-full p-3 border border-slate-200 rounded-xl text-sm outline-none focus:border-blue-500 transition-all resize-none"></textarea>
                        </div>
                        <button onclick="submitMapel()" id="btnAddMapel" class="btn-official w-full py-3 rounded-xl font-bold text-sm uppercase tracking-widest shadow-lg flex items-center justify-center gap-2 mt-4">
                           <i class="fa-solid fa-save"></i> Simpan Paket
                        </button>
                     </div>
                  </div>
               </div>

               <div class="md:col-span-2">
                  <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                     <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <h3 class="font-bold text-slate-700 text-sm">Daftar Paket</h3>
                            <span class="bg-blue-100 text-blue-600 text-xs font-bold px-2 py-1 rounded">${mapels.length}</span>
                        </div>
                        <button id="btn-del-mapel" onclick="processBulkDelete('check-mapel', 'btn-del-mapel', 'deleteMapelConfig')" class="hidden px-3 py-1.5 bg-red-600 text-white rounded-lg font-bold text-xs shadow-md hover:bg-red-700 transition-all flex items-center gap-2">
                             <i class="fa-solid fa-trash"></i> Hapus (<span id="btn-del-mapel-count">0</span>)
                        </button>
                     </div>
                     <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                           <thead>
                              <tr class="bg-slate-50 border-b border-slate-200">
                                 <th class="py-3 px-4 text-center"><input type="checkbox" class="custom-checkbox" data-btn="btn-del-mapel" onclick="toggleAll(this, 'check-mapel')"></th>
                                 <th class="py-3 px-4 text-center text-[10px] font-bold text-slate-500 uppercase">No</th>
                                 <th class="py-3 px-4 text-[10px] font-bold text-slate-500 uppercase">Nama Paket</th>
                                 <th class="py-3 px-4 text-center text-[10px] font-bold text-slate-500 uppercase">Kuota</th>
                                 <th class="py-3 px-4 text-[10px] font-bold text-slate-500 uppercase">Preview Deskripsi</th>
                                 <th class="py-3 px-4 text-center text-[10px] font-bold text-slate-500 uppercase">Hapus</th>
                              </tr>
                           </thead>
                           <tbody>
                              ${mapelRows || '<tr><td colspan="6" class="py-8 text-center text-slate-400 text-sm italic">Belum ada paket mapel dibuat.</td></tr>'}
                           </tbody>
                        </table>
                     </div>
                  </div>
               </div>

            </div>
         `;
        }

        function submitMapel() {
            const nama = document.getElementById('addNama').value;
            const kuota = document.getElementById('addKuota').value;
            const deskripsi = document.getElementById('addDeskripsi').value;

            if (!nama || !kuota) return alert("Nama Paket dan Kuota wajib diisi!");

            const btn = document.getElementById('btnAddMapel');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Menyimpan...`;

            callAPI('addMapel', { nama, kuota, deskripsi }).then(res => {
                alert(res);
                btn.disabled = false;
                btn.innerHTML = originalText;
                if (res && res.includes("Sukses")) loadMapelManager();
            });
        }

        function hapusMapel(nama) {
            if (confirm(`⚠️ HAPUS PAKET: ${nama}?\n\nPastikan tidak ada siswa yang sedang memilih paket ini agar data tidak error.`)) {
                callAPI('deleteMapelConfig', nama).then(res => {
                    alert(res.message);
                    if (res.success) loadMapelManager();
                });
            }
        }

        // --- TAB 3: MANAJEMEN SISWA ---
        function loadSiswaManager() {
            const content = document.getElementById('dashboardContent');
            content.innerHTML = `
          <div class="flex flex-col items-center justify-center py-20 space-y-4">
            <div class="w-12 h-12 border-4 border-primary border-t-blue-300 rounded-full animate-spin"></div>
            <p class="text-slate-400 font-bold text-xs tracking-widest uppercase">Memuat Data Siswa...</p>
          </div>`;

            callAPI('getAllUsers').then(users => {
                renderSiswaManager(users || []);
            });
        }

        function renderSiswaManager(users) {
            const validUsers = users.filter(u => u.nisn && u.nama);

            let rows = validUsers.map((u, index) => `
            <tr class="border-b border-slate-100 hover:bg-slate-50">
               <td class="py-3 px-4 text-center"><input type="checkbox" class="custom-checkbox check-siswa" value="${u.nisn}" onclick="updateBulkBtn('check-siswa', 'btn-del-siswa')"></td>
               <td class="py-3 px-4 text-center text-xs font-bold text-slate-400">${index + 1}</td>
               <td class="py-3 px-4 font-mono text-xs font-bold text-slate-500">${u.nisn}</td>
               <td class="py-3 px-4 font-bold text-slate-700 text-sm">${u.nama}</td>
               <td class="py-3 px-4 text-center">
                  <span class="bg-indigo-50 text-indigo-600 border border-indigo-100 text-[10px] font-bold px-2 py-1 rounded">${u.kelas}</span>
               </td>
               <td class="py-3 px-4 text-center">
                  <button onclick="hapusSiswa('${u.nisn}')" class="text-slate-300 hover:text-red-600 transition-colors">
                     <i class="fa-solid fa-trash-can"></i>
                  </button>
               </td>
            </tr>
          `).join('');

            document.getElementById('dashboardContent').innerHTML = `
            <div class="fade-in grid grid-cols-1 md:grid-cols-3 gap-8">
               
               <!-- FORM TAMBAH SISWA -->
               <div class="md:col-span-1">
                  <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm sticky top-6">
                     <div class="flex items-center gap-2 mb-6 pb-4 border-b border-slate-100">
                        <i class="fa-solid fa-user-plus text-blue-600"></i>
                        <h3 class="font-bold text-slate-800">Tambah Siswa</h3>
                     </div>
                     
                     <div class="space-y-4">
                        <div>
                           <label class="block text-xs font-bold text-slate-400 uppercase mb-2">NISN</label>
                           <input type="number" id="addNISN" placeholder="00123456" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-bold outline-none focus:border-blue-500 transition-all">
                        </div>
                        <div>
                           <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Nama Lengkap</label>
                           <input type="text" id="addNamaSiswa" placeholder="Nama Siswa" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-bold outline-none focus:border-blue-500 transition-all">
                        </div>
                        <div>
                           <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Kelas</label>
                           <input type="text" id="addKelas" placeholder="XI-A" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-bold outline-none focus:border-blue-500 transition-all">
                        </div>
                        <button onclick="submitSiswa()" id="btnAddSiswa" class="btn-official w-full py-3 rounded-xl font-bold text-sm uppercase tracking-widest shadow-lg flex items-center justify-center gap-2 mt-4">
                           <i class="fa-solid fa-save"></i> Simpan Data
                        </button>
                     </div>
                  </div>
               </div>

               <!-- LIST SISWA -->
               <div class="md:col-span-2">
                  <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                     <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <h3 class="font-bold text-slate-700 text-sm">Database Siswa</h3>
                            <span class="bg-indigo-100 text-indigo-600 text-xs font-bold px-2 py-1 rounded">${validUsers.length}</span>
                        </div>
                        <button id="btn-del-siswa" onclick="processBulkDelete('check-siswa', 'btn-del-siswa', 'deleteSiswa')" class="hidden px-3 py-1.5 bg-red-600 text-white rounded-lg font-bold text-xs shadow-md hover:bg-red-700 transition-all flex items-center gap-2">
                             <i class="fa-solid fa-trash"></i> Hapus (<span id="btn-del-siswa-count">0</span>)
                        </button>
                     </div>
                     <div class="overflow-x-auto max-h-[500px]">
                        <table class="w-full text-left border-collapse">
                           <thead class="sticky top-0 bg-slate-50 shadow-sm z-10">
                              <tr class="border-b border-slate-200">
                                 <th class="py-3 px-4 text-center"><input type="checkbox" class="custom-checkbox" data-btn="btn-del-siswa" onclick="toggleAll(this, 'check-siswa')"></th>
                                 <th class="py-3 px-4 text-center text-[10px] font-bold text-slate-500 uppercase">No</th>
                                 <th class="py-3 px-4 text-[10px] font-bold text-slate-500 uppercase">NISN</th>
                                 <th class="py-3 px-4 text-[10px] font-bold text-slate-500 uppercase">Nama</th>
                                 <th class="py-3 px-4 text-center text-[10px] font-bold text-slate-500 uppercase">Kelas</th>
                                 <th class="py-3 px-4 text-center text-[10px] font-bold text-slate-500 uppercase">Aksi</th>
                              </tr>
                           </thead>
                           <tbody>
                              ${rows || '<tr><td colspan="6" class="py-8 text-center text-slate-400 text-sm italic">Belum ada data siswa.</td></tr>'}
                           </tbody>
                        </table>
                     </div>
                  </div>
               </div>

            </div>
          `;
        }

        function submitSiswa() {
            const nisn = document.getElementById('addNISN').value;
            const nama = document.getElementById('addNamaSiswa').value;
            const kelas = document.getElementById('addKelas').value;

            if (!nisn || !nama || !kelas) return alert("Semua kolom wajib diisi!");

            const btn = document.getElementById('btnAddSiswa');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Proses...`;

            callAPI('addSiswa', { nisn, nama, kelas }).then(res => {
                alert(res);
                btn.disabled = false;
                btn.innerHTML = originalText;
                if (res && res.includes("Sukses")) loadSiswaManager();
            });
        }

        function hapusSiswa(nisn) {
            if (confirm(`Hapus data siswa dengan NISN: ${nisn}?`)) {
                callAPI('deleteSiswa', nisn).then(res => {
                    alert(res.message);
                    if (res.success) loadSiswaManager();
                });
            }
        }

        // --- TAB 4: MANAJEMEN STAFF (NEW!) ---
        function loadStaffManager() {
            const content = document.getElementById('dashboardContent');
            content.innerHTML = `
          <div class="flex flex-col items-center justify-center py-20 space-y-4">
            <div class="w-12 h-12 border-4 border-primary border-t-red-400 rounded-full animate-spin"></div>
            <p class="text-slate-400 font-bold text-xs tracking-widest uppercase">Memuat Data Admin...</p>
          </div>`;

            callAPI('getStaffList').then(staffs => {
                renderStaffManager(staffs || []);
            });
        }

        function renderStaffManager(staffs) {
            let rows = staffs.map((s, index) => `
            <tr class="border-b border-slate-100 hover:bg-slate-50">
               <td class="py-3 px-4 text-center"><input type="checkbox" class="custom-checkbox check-staff" value="${s.email}" onclick="updateBulkBtn('check-staff', 'btn-del-staff')"></td>
               <td class="py-3 px-4 text-center text-xs font-bold text-slate-400">${index + 1}</td>
               <td class="py-3 px-4 font-bold text-slate-600 text-xs">${s.email}</td>
               <td class="py-3 px-4 font-bold text-slate-800 text-sm">${s.nama}</td>
               <td class="py-3 px-4 text-center">
                  <span class="bg-red-50 text-red-600 border border-red-100 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">${s.role}</span>
               </td>
               <td class="py-3 px-4 text-center">
                  <button onclick="hapusStaff('${s.email}')" class="text-slate-300 hover:text-red-600 transition-colors">
                     <i class="fa-solid fa-trash-can"></i>
                  </button>
               </td>
            </tr>
          `).join('');

            document.getElementById('dashboardContent').innerHTML = `
            <div class="fade-in grid grid-cols-1 md:grid-cols-3 gap-8">
               
               <!-- FORM TAMBAH STAFF -->
               <div class="md:col-span-1">
                  <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm sticky top-6">
                     <div class="flex items-center gap-2 mb-6 pb-4 border-b border-slate-100">
                        <i class="fa-solid fa-user-shield text-blue-600"></i>
                        <h3 class="font-bold text-slate-800">Tambah Admin</h3>
                     </div>
                     
                     <div class="space-y-4">
                        <div>
                           <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Email Google</label>
                           <input type="email" id="addEmailStaff" placeholder="guru@sekolah.sch.id" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-bold outline-none focus:border-blue-500 transition-all">
                        </div>
                        <div>
                           <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Nama Lengkap</label>
                           <input type="text" id="addNamaStaff" placeholder="Nama Guru/Staff" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-bold outline-none focus:border-blue-500 transition-all">
                        </div>
                        <div>
                           <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Role Akses</label>
                           <select id="addRoleStaff" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-bold outline-none focus:border-blue-500 transition-all bg-white cursor-pointer">
                              <option value="Admin">Super Admin</option>
                              <option value="BK">Guru BK</option>
                              <option value="Staff">Staff Kurikulum</option>
                           </select>
                        </div>
                        <button onclick="submitStaff()" id="btnAddStaff" class="btn-official w-full py-3 rounded-xl font-bold text-sm uppercase tracking-widest shadow-lg flex items-center justify-center gap-2 mt-4">
                           <i class="fa-solid fa-save"></i> Berikan Akses
                        </button>
                     </div>
                  </div>
               </div>

               <!-- LIST STAFF -->
               <div class="md:col-span-2">
                  <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                     <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                        <div class="flex items-center gap-2">
                             <h3 class="font-bold text-slate-700 text-sm">Pengelola Aplikasi</h3>
                             <span class="bg-red-50 text-red-600 text-xs font-bold px-2 py-1 rounded">${staffs.length}</span>
                        </div>
                        <button id="btn-del-staff" onclick="processBulkDelete('check-staff', 'btn-del-staff', 'deleteStaff')" class="hidden px-3 py-1.5 bg-red-600 text-white rounded-lg font-bold text-xs shadow-md hover:bg-red-700 transition-all flex items-center gap-2">
                             <i class="fa-solid fa-trash"></i> Hapus (<span id="btn-del-staff-count">0</span>)
                        </button>
                     </div>
                     <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                           <thead class="bg-slate-50">
                              <tr class="border-b border-slate-200">
                                 <th class="py-3 px-4 text-center"><input type="checkbox" class="custom-checkbox" data-btn="btn-del-staff" onclick="toggleAll(this, 'check-staff')"></th>
                                 <th class="py-3 px-4 text-center text-[10px] font-bold text-slate-500 uppercase">No</th>
                                 <th class="py-3 px-4 text-[10px] font-bold text-slate-500 uppercase">Email</th>
                                 <th class="py-3 px-4 text-[10px] font-bold text-slate-500 uppercase">Nama</th>
                                 <th class="py-3 px-4 text-center text-[10px] font-bold text-slate-500 uppercase">Role</th>
                                 <th class="py-3 px-4 text-center text-[10px] font-bold text-slate-500 uppercase">Aksi</th>
                              </tr>
                           </thead>
                           <tbody>
                              ${rows || '<tr><td colspan="6" class="py-8 text-center text-slate-400 text-sm italic">Belum ada admin terdaftar.</td></tr>'}
                           </tbody>
                        </table>
                     </div>
                  </div>
               </div>

            </div>
          `;
        }

        function submitStaff() {
            const email = document.getElementById('addEmailStaff').value;
            const nama = document.getElementById('addNamaStaff').value;
            const role = document.getElementById('addRoleStaff').value;

            if (!email || !nama) return alert("Email dan Nama wajib diisi!");

            const btn = document.getElementById('btnAddStaff');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Proses...`;

            callAPI('addStaff', { email, nama, role }).then(res => {
                alert(res);
                btn.disabled = false;
                btn.innerHTML = originalText;
                if (res && res.includes("Sukses")) loadStaffManager();
            });
        }

        function hapusStaff(email) {
            if (confirm(`Cabut akses admin untuk email: ${email}?`)) {
                callAPI('deleteStaff', email).then(res => {
                    alert(res.message);
                    if (res.success) loadStaffManager();
                });
            }
        }
    </script>
</body>

</html>